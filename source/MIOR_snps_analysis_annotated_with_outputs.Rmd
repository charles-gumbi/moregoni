---
title: 'Microtus oregoni Autosomal vs Sex chromosome genetic structure'
author: "Bonginkosi Charles Gumbi"
date: '`r Sys.Date()`'
output:
  pdf_document: default
  html_document: default
email: chrlesgumbi@gmail.com
---

# SNP Analysis Workflow for *Microtus oregoni*
This document contains the analysis of SNP data comparing autosomal vs. sex chromosome genetic structure.  
Each section is annotated for clarity, and we also describe what to expect from the outputs.

---

# 1. Install Required Packages
We first ensure that all required packages are installed.  
Some packages are from CRAN, others from GitHub.

```{r install_packages, eval=FALSE}
# Install packages from CRAN
# install.packages("devtools")
# install.packages("parallelly", dependencies = TRUE)

# Install packages from GitHub if needed
# devtools::install_github("SexGenomicsToolkit/sgtr")
# devtools::install_github("TheWangLab/algatr")
# devtools::install_github("Bioconductor-mirror/LEA", force=TRUE)
# devtools::install_github("nspope/r2vcftools")

# Install Bioconductor packages
# if (!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager")
# BiocManager::install("gdsfmt")
# BiocManager::install("SNPRelate")
```

---

# 2. Load Libraries
Load the R libraries that will be used throughout the workflow.

```{r load_libraries}
library(sgtr)         # Sex Genomics Toolkit
library(stringr)      # String manipulation
library(adegenet)     # Genetic data analysis
library(vcfR)         # VCF file processing
library(r2vcftools)   # Interface to VCFtools
library(LEA)          # Landscape and ecological association studies
library(SNPRelate)    # SNP analysis and PCA
```

*Output:* No plots. You should see the libraries load without error. If there are errors, it usually means a package is missing.

---

# 3. Import and Inspect VCF Data
We import VCF data, inspect its structure, and prepare it for downstream analysis.

```{r import_vcf}
# Load the VCF file
vcf_file <- "path/to/your_data.vcf.gz"
vcf <- read.vcfR(vcf_file)

# Basic summary of the VCF
print(vcf)
summary(vcf)
```

*Output:* You should see the number of SNPs, individuals, and some metadata about your dataset. This confirms the file was read correctly.

---

# 4. Convert VCF to Genlight Object
The `genlight` format is useful for population genetics analyses in adegenet.

```{r vcf_to_genlight}
genlight_obj <- vcfR2genlight(vcf)

# Display basic info about the genlight object
genlight_obj
```

*Output:* Expect to see the number of individuals and SNPs stored in the genlight object. This confirms the conversion worked.

---

# 5. Principal Component Analysis (PCA)
We perform PCA to explore genetic structure among individuals.

```{r pca_analysis}
# Run PCA
pca_result <- glPca(genlight_obj, nf = 3)  # keep first 3 components

# Plot PCA
scatter(pca_result, posi="bottomright", scree.da=FALSE, bg="white")
```

*Output:* A PCA scatter plot where individuals are distributed according to genetic similarity. Clusters may correspond to populations or sexes.  
Interpretation: If sex chromosomes strongly differentiate individuals, you may see distinct clusters separating males and females.

---

# 6. SNP Relate Conversion and Analysis
Convert VCF to GDS format and use SNPRelate functions for more detailed population structure analyses.

```{r snprelate_conversion}
# Convert VCF to GDS format
gds_file <- "snps.gds"
snpgdsVCF2GDS(vcf_file, gds_file, method="biallelic.only")

# Open the GDS file
genofile <- snpgdsOpen(gds_file)

# Perform PCA with SNPRelate
pca <- snpgdsPCA(genofile, num.thread=2)
summary(pca)

# Close GDS file
snpgdsClose(genofile)
```

*Output:* You should see eigenvalues, variance explained, and PCA loadings. The percentages of variance explained by PC1, PC2, etc., tell you how much structure is captured.  
Interpretation: Larger variance explained by early PCs suggests stronger structure.

---

# 7. ADMIXTURE or Ancestry Estimation
Use LEA for ancestry estimation with sparse nonnegative matrix factorization (snmf).

```{r admixture_analysis}
# Run snmf for K=1 to 5
project <- snmf("snps.geno", K = 1:5, entropy=TRUE, repetitions=3, project="new")

# Cross-entropy plot to select best K
plot(project, col="blue", pch=19)
```

*Output:* A plot of cross-entropy values across K. The lowest value indicates the best-supported number of ancestral populations.  
Interpretation: If sex-linked differentiation is strong, you may see clear structure at K=2 (e.g., males vs. females).

---

# 8. Save Results and Session Info
We save results and document the R session for reproducibility.

```{r save_results}
# Save PCA results
saveRDS(pca_result, "pca_result.rds")

# Save session info
sessionInfo()
```

*Output:* The R session info lists R version, platform, and packages. This ensures analyses can be reproduced later.

---
